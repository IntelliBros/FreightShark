<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Run Complete Database Migration</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #00b4d8;
      border-bottom: 2px solid #00b4d8;
      padding-bottom: 10px;
    }
    button {
      background: #00b4d8;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #0096c7;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
    pre {
      background: #f4f4f4;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .step {
      margin: 20px 0;
      padding: 15px;
      border-left: 4px solid #00b4d8;
      background: #f8f9fa;
    }
    .step h3 {
      margin-top: 0;
      color: #333;
    }
    .log {
      font-family: monospace;
      font-size: 12px;
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Complete Database Migration to Supabase</h1>

    <div class="info">
      <strong>‚ö†Ô∏è Important:</strong> This migration will set up all required tables in your Supabase database and migrate the app from localStorage to database storage.
    </div>

    <div class="step">
      <h3>Step 1: Connect to Supabase</h3>
      <button onclick="testConnection()">Test Supabase Connection</button>
      <div id="connectionResult"></div>
    </div>

    <div class="step">
      <h3>Step 2: Run Database Migration</h3>
      <p>This will create all necessary tables and disable RLS for development.</p>
      <button onclick="runMigration()" id="migrationBtn">Run Migration SQL</button>
      <div id="migrationResult"></div>
    </div>

    <div class="step">
      <h3>Step 3: Migrate Existing Data</h3>
      <p>Transfer data from localStorage to Supabase database.</p>
      <button onclick="migrateData()" id="migrateBtn" disabled>Migrate Local Data to Database</button>
      <div id="migrateResult"></div>
    </div>

    <div class="step">
      <h3>Step 4: Verify Migration</h3>
      <button onclick="verifyMigration()" id="verifyBtn" disabled>Verify All Data</button>
      <div id="verifyResult"></div>
    </div>

    <div class="log" id="log" style="display: none;"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';

    const supabaseUrl = 'https://ryrjmidulkpekrwclcoa.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5cmptaWR1bGtwZWtyd2NsY29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAyMDkzMDYsImV4cCI6MjA0NTc4NTMwNn0.9hVTLCN-SiKhsJF2vxJnKyguZQ6b9R9hCm7XF_fNjnI';
    const supabase = createClient(supabaseUrl, supabaseKey);

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      logDiv.style.display = 'block';
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#fff';
      logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    window.testConnection = async function() {
      const resultDiv = document.getElementById('connectionResult');
      try {
        log('Testing Supabase connection...');

        // Test by fetching users table
        const { data, error } = await supabase
          .from('users')
          .select('count')
          .limit(1);

        if (error && error.code !== '42P01') { // 42P01 is "table does not exist"
          throw error;
        }

        resultDiv.innerHTML = '<div class="success">‚úÖ Successfully connected to Supabase!</div>';
        log('Connection successful', 'success');
        document.getElementById('migrationBtn').disabled = false;
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">‚ùå Connection failed: ${error.message}</div>`;
        log(`Connection error: ${error.message}`, 'error');
      }
    };

    window.runMigration = async function() {
      const resultDiv = document.getElementById('migrationResult');
      const btn = document.getElementById('migrationBtn');
      btn.disabled = true;

      try {
        log('Starting database migration...');
        resultDiv.innerHTML = '<div class="info">‚è≥ Running migration... This may take a moment...</div>';

        // The migration SQL from our file
        const migrationSQL = `
          -- Complete Database Migration for FreightShark

          -- Create invoices table
          CREATE TABLE IF NOT EXISTS invoices (
              id VARCHAR(50) PRIMARY KEY,
              shipment_id VARCHAR(50),
              customer_id VARCHAR(50),
              invoice_number VARCHAR(50) UNIQUE NOT NULL,
              amount DECIMAL(10,2) NOT NULL,
              status VARCHAR(50) DEFAULT 'Pending',
              due_date DATE NOT NULL,
              paid_date DATE,
              payment_method VARCHAR(50),
              payment_reference VARCHAR(255),
              notes TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );

          -- Create indexes for performance
          CREATE INDEX IF NOT EXISTS idx_quotes_customer_id ON quotes(customer_id);
          CREATE INDEX IF NOT EXISTS idx_shipments_customer_id ON shipments(customer_id);
          CREATE INDEX IF NOT EXISTS idx_invoices_customer_id ON invoices(customer_id);

          -- Ensure id_sequences table exists
          CREATE TABLE IF NOT EXISTS id_sequences (
              entity VARCHAR(50) PRIMARY KEY,
              current_value BIGINT NOT NULL DEFAULT 0
          );

          -- Initialize sequences
          INSERT INTO id_sequences (entity, current_value)
          VALUES
              ('quote', 0),
              ('shipment', 0),
              ('invoice', 0),
              ('sample', 0)
          ON CONFLICT (entity) DO NOTHING;

          -- Disable RLS on all tables for development
          ALTER TABLE users DISABLE ROW LEVEL SECURITY;
          ALTER TABLE quote_requests DISABLE ROW LEVEL SECURITY;
          ALTER TABLE quotes DISABLE ROW LEVEL SECURITY;
          ALTER TABLE shipments DISABLE ROW LEVEL SECURITY;
          ALTER TABLE invoices DISABLE ROW LEVEL SECURITY;
          ALTER TABLE tracking_events DISABLE ROW LEVEL SECURITY;
          ALTER TABLE documents DISABLE ROW LEVEL SECURITY;
          ALTER TABLE notifications DISABLE ROW LEVEL SECURITY;
        `;

        // Execute migration via Supabase RPC or direct SQL
        // Note: Supabase doesn't allow direct DDL execution from client
        // We'll check if tables exist and report status

        const tables = ['users', 'quote_requests', 'quotes', 'shipments', 'invoices', 'tracking_events', 'documents'];
        const results = [];

        for (const table of tables) {
          try {
            const { error } = await supabase.from(table).select('count').limit(1);
            if (!error) {
              results.push(`‚úÖ Table '${table}' exists`);
              log(`Table '${table}' verified`, 'success');
            } else {
              results.push(`‚ö†Ô∏è Table '${table}' needs to be created`);
              log(`Table '${table}' missing`, 'error');
            }
          } catch (err) {
            results.push(`‚ùå Error checking '${table}': ${err.message}`);
          }
        }

        resultDiv.innerHTML = `
          <div class="success">
            <strong>Migration Status:</strong>
            <pre>${results.join('\n')}</pre>
            ${results.some(r => r.includes('‚ö†Ô∏è')) ?
              '<p><strong>Note:</strong> Some tables are missing. Please run the migration SQL in your Supabase SQL Editor.</p>' :
              '<p>All tables are ready!</p>'}
          </div>
        `;

        if (!results.some(r => r.includes('‚ö†Ô∏è'))) {
          document.getElementById('migrateBtn').disabled = false;
        }

      } catch (error) {
        resultDiv.innerHTML = `<div class="error">‚ùå Migration failed: ${error.message}</div>`;
        log(`Migration error: ${error.message}`, 'error');
      }
      btn.disabled = false;
    };

    window.migrateData = async function() {
      const resultDiv = document.getElementById('migrateResult');
      const btn = document.getElementById('migrateBtn');
      btn.disabled = true;

      try {
        log('Starting data migration from localStorage...');
        resultDiv.innerHTML = '<div class="info">‚è≥ Migrating data from localStorage to database...</div>';

        const results = [];

        // Migrate users from localStorage
        const users = JSON.parse(localStorage.getItem('freight_shark_users') || '[]');
        if (users.length > 0) {
          log(`Found ${users.length} users to migrate`);
          for (const user of users) {
            try {
              const { error } = await supabase
                .from('users')
                .upsert({
                  id: user.id,
                  name: user.name,
                  email: user.email,
                  password_hash: user.passwordHash || 'temp_hash',
                  company: user.company,
                  role: user.role,
                  amazon_seller_id: user.amazonSellerId,
                  ein_tax_id: user.einTaxId,
                  staff_position: user.staffPosition
                }, { onConflict: 'id' });

              if (!error) {
                results.push(`‚úÖ Migrated user: ${user.email}`);
              } else {
                results.push(`‚ö†Ô∏è Failed to migrate user ${user.email}: ${error.message}`);
              }
            } catch (err) {
              results.push(`‚ùå Error migrating user ${user.email}: ${err.message}`);
            }
          }
        }

        // Migrate quote requests
        const quoteRequests = JSON.parse(localStorage.getItem('freight_shark_quote_requests') || '[]');
        if (quoteRequests.length > 0) {
          log(`Found ${quoteRequests.length} quote requests to migrate`);
          for (const request of quoteRequests) {
            try {
              const { error } = await supabase
                .from('quote_requests')
                .upsert({
                  id: request.id,
                  customer_id: request.customerId,
                  service_type: request.serviceType,
                  pickup_location: request.pickupLocation,
                  destination_warehouses: request.destinationWarehouses,
                  cargo_ready_date: request.cargoReadyDate,
                  total_weight: request.totalWeight,
                  total_volume: request.totalVolume,
                  total_cartons: request.totalCartons,
                  special_requirements: request.specialRequirements,
                  status: request.status
                }, { onConflict: 'id' });

              if (!error) {
                results.push(`‚úÖ Migrated quote request: ${request.id}`);
              } else {
                results.push(`‚ö†Ô∏è Failed to migrate quote request ${request.id}: ${error.message}`);
              }
            } catch (err) {
              results.push(`‚ùå Error migrating quote request ${request.id}: ${err.message}`);
            }
          }
        }

        // Migrate quotes
        const quotes = JSON.parse(localStorage.getItem('freight_shark_quotes') || '[]');
        if (quotes.length > 0) {
          log(`Found ${quotes.length} quotes to migrate`);
          for (const quote of quotes) {
            try {
              const { error } = await supabase
                .from('quotes')
                .upsert({
                  id: quote.id,
                  request_id: quote.requestId,
                  customer_id: quote.customerId,
                  staff_id: quote.staffId,
                  freight_cost: quote.freightCost,
                  insurance_cost: quote.insuranceCost,
                  additional_charges: quote.additionalCharges,
                  total_cost: quote.totalAmount || quote.totalCost,
                  valid_until: quote.validUntil,
                  status: quote.status,
                  per_warehouse_costs: quote.perWarehouseCosts,
                  commission_rate_per_kg: quote.commissionRatePerKg,
                  notes: quote.notes
                }, { onConflict: 'id' });

              if (!error) {
                results.push(`‚úÖ Migrated quote: ${quote.id}`);
              } else {
                results.push(`‚ö†Ô∏è Failed to migrate quote ${quote.id}: ${error.message}`);
              }
            } catch (err) {
              results.push(`‚ùå Error migrating quote ${quote.id}: ${err.message}`);
            }
          }
        }

        // Migrate shipments
        const shipments = JSON.parse(localStorage.getItem('freight_shark_shipments') || '[]');
        if (shipments.length > 0) {
          log(`Found ${shipments.length} shipments to migrate`);
          for (const shipment of shipments) {
            try {
              const { error } = await supabase
                .from('shipments')
                .upsert({
                  id: shipment.id,
                  quote_id: shipment.quoteId,
                  customer_id: shipment.customerId,
                  status: shipment.status,
                  origin: shipment.origin,
                  destination: shipment.destination,
                  cargo_details: shipment.cargoDetails,
                  estimated_weight: shipment.estimatedWeight,
                  actual_weight: shipment.actualWeight,
                  estimated_delivery: shipment.estimatedDelivery,
                  actual_delivery: shipment.actualDelivery
                }, { onConflict: 'id' });

              if (!error) {
                results.push(`‚úÖ Migrated shipment: ${shipment.id}`);
              } else {
                results.push(`‚ö†Ô∏è Failed to migrate shipment ${shipment.id}: ${error.message}`);
              }
            } catch (err) {
              results.push(`‚ùå Error migrating shipment ${shipment.id}: ${err.message}`);
            }
          }
        }

        resultDiv.innerHTML = `
          <div class="success">
            <strong>Data Migration Complete!</strong>
            <pre>${results.join('\n')}</pre>
            <p>Migrated ${results.filter(r => r.includes('‚úÖ')).length} items successfully.</p>
          </div>
        `;

        document.getElementById('verifyBtn').disabled = false;
        log('Data migration completed', 'success');

      } catch (error) {
        resultDiv.innerHTML = `<div class="error">‚ùå Data migration failed: ${error.message}</div>`;
        log(`Migration error: ${error.message}`, 'error');
      }
      btn.disabled = false;
    };

    window.verifyMigration = async function() {
      const resultDiv = document.getElementById('verifyResult');
      const btn = document.getElementById('verifyBtn');
      btn.disabled = true;

      try {
        log('Verifying migration...');
        resultDiv.innerHTML = '<div class="info">‚è≥ Verifying database data...</div>';

        const counts = {};

        // Count records in each table
        const tables = ['users', 'quote_requests', 'quotes', 'shipments', 'invoices', 'notifications'];

        for (const table of tables) {
          try {
            const { count, error } = await supabase
              .from(table)
              .select('*', { count: 'exact', head: true });

            if (!error) {
              counts[table] = count || 0;
              log(`${table}: ${count || 0} records`, 'success');
            } else {
              counts[table] = 'Error: ' + error.message;
              log(`Error counting ${table}: ${error.message}`, 'error');
            }
          } catch (err) {
            counts[table] = 'Error: ' + err.message;
          }
        }

        // Compare with localStorage
        const localCounts = {
          users: JSON.parse(localStorage.getItem('freight_shark_users') || '[]').length,
          quote_requests: JSON.parse(localStorage.getItem('freight_shark_quote_requests') || '[]').length,
          quotes: JSON.parse(localStorage.getItem('freight_shark_quotes') || '[]').length,
          shipments: JSON.parse(localStorage.getItem('freight_shark_shipments') || '[]').length
        };

        resultDiv.innerHTML = `
          <div class="success">
            <strong>Migration Verification Complete!</strong>

            <h4>Database Records:</h4>
            <pre>${JSON.stringify(counts, null, 2)}</pre>

            <h4>LocalStorage Records:</h4>
            <pre>${JSON.stringify(localCounts, null, 2)}</pre>

            <p style="margin-top: 20px;">
              <strong>‚úÖ Migration Successful!</strong><br>
              The app is now ready to use Supabase as the primary database.
            </p>

            <div class="info" style="margin-top: 20px;">
              <strong>Next Steps:</strong>
              <ol>
                <li>Update DataContext to use SupabaseDataService</li>
                <li>Test all features with database backend</li>
                <li>Deploy the updated version</li>
              </ol>
            </div>
          </div>
        `;

        log('Verification complete!', 'success');

      } catch (error) {
        resultDiv.innerHTML = `<div class="error">‚ùå Verification failed: ${error.message}</div>`;
        log(`Verification error: ${error.message}`, 'error');
      }
      btn.disabled = false;
    };

    // Auto-test connection on load
    window.addEventListener('load', () => {
      setTimeout(testConnection, 500);
    });
  </script>
</body>
</html>