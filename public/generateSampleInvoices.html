<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Sample Invoices</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #1a202c;
            margin-bottom: 10px;
        }
        .description {
            color: #718096;
            margin-bottom: 30px;
        }
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #3182ce;
        }
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .success {
            background: #48bb78;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        .error {
            background: #f56565;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        .log {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4299e1;
            padding-left: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stat-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        .stat-label {
            color: #718096;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßæ Generate Sample Invoices & Documents</h1>
        <p class="description">
            This tool will generate sample invoices and documents for existing shipments to populate the Documents Hub.
        </p>

        <div>
            <button onclick="generateInvoices()">Generate Invoices for All Shipments</button>
            <button onclick="generateDocuments()">Generate Sample Documents</button>
            <button onclick="clearAll()">Clear All Documents</button>
        </div>

        <div id="stats" class="stats"></div>
        <div id="status"></div>
        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://jqcbgpwheckblkdejuwv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxY2JncHdoZWNrYmxrZGVqdXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNjMzMTUsImV4cCI6MjA3MjkzOTMxNX0.n6uAu_3phhkm0FqPuJxX4LM2alBBqquEqzOCL7ubmHI';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Test connection on load
        async function testConnection() {
            try {
                const { data, error } = await supabase
                    .from('shipments')
                    .select('id')
                    .limit(1);

                if (error) {
                    showStatus(`Database connection error: ${error.message}`, 'error');
                    addLog('‚ùå Failed to connect to database');
                    console.error('Supabase connection error:', error);
                    return false;
                } else {
                    addLog('‚úÖ Connected to database successfully');
                    return true;
                }
            } catch (err) {
                showStatus(`Connection failed: ${err.message}. Please check your internet connection.`, 'error');
                addLog('‚ùå Connection failed - check network/DNS');
                console.error('Connection error:', err);
                return false;
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = type === 'error' ? 'error' : 'success';
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function addLog(message) {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showStats(shipments, invoices, documents) {
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${shipments}</div>
                    <div class="stat-label">Total Shipments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${invoices}</div>
                    <div class="stat-label">Invoices Generated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${documents}</div>
                    <div class="stat-label">Documents Created</div>
                </div>
            `;
        }

        async function generateInvoices() {
            try {
                // Test connection first
                const connected = await testConnection();
                if (!connected) {
                    showStatus('Cannot connect to database. Please check your connection and try again.', 'error');
                    return;
                }

                addLog('Starting invoice generation...');

                // Get all shipments
                const { data: shipments, error: shipError } = await supabase
                    .from('shipments')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (shipError) throw shipError;

                addLog(`Found ${shipments.length} shipments`);

                let invoiceCount = 0;

                for (const shipment of shipments) {
                    // Skip if shipment already has an invoice
                    if (shipment.invoice) {
                        addLog(`Skipping ${shipment.id} - already has invoice`);
                        continue;
                    }

                    // Generate invoice data
                    const invoiceData = {
                        id: `INV-${shipment.id}-${Date.now()}`,
                        invoice_number: `INV-${shipment.id}`,
                        shipment_id: shipment.id,
                        customer_id: shipment.customer_id,
                        status: 'Paid',
                        issue_date: new Date().toISOString(),
                        due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                        subtotal: Math.floor(Math.random() * 5000) + 1000,
                        tax: Math.floor(Math.random() * 500) + 50,
                        total_amount: 0,
                        paid_amount: 0,
                        payment_date: new Date().toISOString(),
                        payment_method: 'Wire Transfer',
                        notes: 'Sample invoice generated for demonstration',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };

                    invoiceData.total_amount = invoiceData.subtotal + invoiceData.tax;
                    invoiceData.paid_amount = invoiceData.total_amount;

                    // Update shipment with invoice
                    const { error: updateError } = await supabase
                        .from('shipments')
                        .update({
                            invoice: invoiceData,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', shipment.id);

                    if (updateError) {
                        addLog(`Error updating ${shipment.id}: ${updateError.message}`);
                    } else {
                        addLog(`‚úÖ Generated invoice for ${shipment.id}`);
                        invoiceCount++;
                    }
                }

                showStats(shipments.length, invoiceCount, 0);
                showStatus(`Successfully generated ${invoiceCount} invoices!`);

            } catch (error) {
                console.error('Error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function generateDocuments() {
            try {
                addLog('Starting document generation...');

                // Get all shipments
                const { data: shipments, error: shipError } = await supabase
                    .from('shipments')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (shipError) throw shipError;

                addLog(`Found ${shipments.length} shipments`);

                let docCount = 0;

                const documentTypes = [
                    { type: 'packing-list', name: 'Packing List' },
                    { type: 'awb', name: 'Air Waybill' },
                    { type: 'customs', name: 'Customs Declaration' },
                    { type: 'pod', name: 'Proof of Delivery' }
                ];

                for (const shipment of shipments) {
                    // Generate 1-3 random documents per shipment
                    const numDocs = Math.floor(Math.random() * 3) + 1;
                    const documents = [];

                    for (let i = 0; i < numDocs; i++) {
                        const docType = documentTypes[Math.floor(Math.random() * documentTypes.length)];
                        documents.push({
                            id: `DOC-${shipment.id}-${Date.now()}-${i}`,
                            name: `${docType.name} - ${shipment.id}.pdf`,
                            type: docType.type,
                            size: `${Math.floor(Math.random() * 900) + 100}KB`,
                            uploadedAt: new Date().toISOString(),
                            uploadedBy: 'System Demo',
                            url: '#'
                        });
                    }

                    // Update shipment with documents
                    const { error: updateError } = await supabase
                        .from('shipments')
                        .update({
                            documents: documents,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', shipment.id);

                    if (updateError) {
                        addLog(`Error updating ${shipment.id}: ${updateError.message}`);
                    } else {
                        addLog(`‚úÖ Added ${documents.length} documents to ${shipment.id}`);
                        docCount += documents.length;
                    }
                }

                showStats(shipments.length, 0, docCount);
                showStatus(`Successfully generated ${docCount} documents!`);

            } catch (error) {
                console.error('Error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function clearAll() {
            try {
                if (!confirm('Are you sure you want to clear all invoices and documents?')) return;

                addLog('Clearing all documents and invoices...');

                // Get all shipments
                const { data: shipments, error: shipError } = await supabase
                    .from('shipments')
                    .select('id');

                if (shipError) throw shipError;

                let clearedCount = 0;

                for (const shipment of shipments) {
                    const { error: updateError } = await supabase
                        .from('shipments')
                        .update({
                            invoice: null,
                            documents: null,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', shipment.id);

                    if (!updateError) {
                        addLog(`Cleared ${shipment.id}`);
                        clearedCount++;
                    }
                }

                showStats(shipments.length, 0, 0);
                showStatus(`Cleared documents from ${clearedCount} shipments`);

            } catch (error) {
                console.error('Error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Load initial stats
        window.addEventListener('load', async () => {
            try {
                // Test connection first
                const connected = await testConnection();

                if (connected) {
                    const { data: shipments, error } = await supabase
                        .from('shipments')
                        .select('invoice, documents');

                    if (error) {
                        console.error('Error loading stats:', error);
                        showStats(0, 0, 0);
                    } else if (shipments) {
                        const invoiceCount = shipments.filter(s => s.invoice).length;
                        const docCount = shipments.reduce((sum, s) => sum + (s.documents?.length || 0), 0);
                        showStats(shipments.length, invoiceCount, docCount);
                    }
                } else {
                    showStats(0, 0, 0);
                    showStatus('‚ö†Ô∏è Cannot connect to database. This might be a network issue or DNS problem. Try refreshing the page.', 'error');
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                showStats(0, 0, 0);
            }
        });
    </script>
</body>
</html>