<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer Documents Data</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #1a202c;
            margin-bottom: 10px;
        }
        .warning {
            background: #fff5f5;
            border: 2px solid #feb2b2;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .info {
            background: #ebf8ff;
            border: 2px solid #90cdf4;
            color: #2c5282;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background: #48bb78;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        .error {
            background: #f56565;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #3182ce;
        }
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .danger-button {
            background: #f56565;
        }
        .danger-button:hover {
            background: #e53e3e;
        }
        .log {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4299e1;
            padding-left: 10px;
        }
        .log-entry.error {
            border-left-color: #f56565;
        }
        .log-entry.success {
            border-left-color: #48bb78;
        }
        .log-entry.warning {
            border-left-color: #ecc94b;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        .stat-label {
            color: #718096;
            font-size: 14px;
            margin-top: 5px;
        }
        .preview-box {
            background: #2d3748;
            color: #68d391;
            padding: 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÑ‚û°Ô∏èüìÅ Transfer Documents Data</h1>

        <div class="info">
            <strong>What this tool does:</strong>
            <ul>
                <li>Analyzes the destination column for document-like data</li>
                <li>Transfers any documents found to the documents column</li>
                <li>Preserves actual destination data (location information)</li>
                <li>Creates a backup before making changes</li>
            </ul>
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è Warning:</strong> This will modify your database. The tool will:
            <ol>
                <li>First scan to identify documents in the destination column</li>
                <li>Show you a preview of what will be transferred</li>
                <li>Only proceed with your confirmation</li>
            </ol>
        </div>

        <div id="stats" class="stats" style="display: none;"></div>

        <div style="margin-top: 30px;">
            <button onclick="analyzeData()">1. Analyze Current Data</button>
            <button onclick="previewTransfer()" disabled id="previewBtn">2. Preview Transfer</button>
            <button onclick="executeTransfer()" disabled id="transferBtn">3. Execute Transfer</button>
            <button onclick="verifyTransfer()" disabled id="verifyBtn">4. Verify Results</button>
        </div>

        <div id="preview" class="preview-box" style="display: none;"></div>
        <div id="status"></div>
        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://jqcbgpwheckblkdejuwv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxY2JncHdoZWNrYmxrZGVqdXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNjMzMTUsImV4cCI6MjA3MjkzOTMxNX0.n6uAu_3phhkm0FqPuJxX4LM2alBBqquEqzOCL7ubmHI';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let shipmentsWithDocuments = [];
        let documentsToTransfer = [];

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = type === 'error' ? 'error' : 'success';
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showStats(stats) {
            const statsDiv = document.getElementById('stats');
            statsDiv.style.display = 'grid';
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalShipments || 0}</div>
                    <div class="stat-label">Total Shipments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.shipmentsWithDestination || 0}</div>
                    <div class="stat-label">With Destination Data</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.documentsFound || 0}</div>
                    <div class="stat-label">Documents Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.shipmentsToUpdate || 0}</div>
                    <div class="stat-label">Shipments to Update</div>
                </div>
            `;
        }

        function isDocumentData(item) {
            // Check if this looks like a document
            if (!item || typeof item !== 'object') return false;

            // Document indicators
            const hasDocumentFields = (
                'name' in item ||
                'url' in item ||
                'type' in item ||
                'size' in item ||
                'uploadedAt' in item ||
                'uploadedBy' in item
            );

            // Destination/location indicators (these mean it's NOT a document)
            const hasDestinationFields = (
                'fbaWarehouse' in item ||
                'amazonShipmentId' in item ||
                'amazonReferenceId' in item ||
                'address' in item ||
                'city' in item ||
                'country' in item ||
                'coordinates' in item
            );

            // It's a document if it has document fields and NOT destination fields
            return hasDocumentFields && !hasDestinationFields;
        }

        async function analyzeData() {
            try {
                addLog('Starting data analysis...', 'info');

                // Fetch all shipments
                const { data: shipments, error } = await supabase
                    .from('shipments')
                    .select('*');

                if (error) throw error;

                addLog(`Found ${shipments.length} total shipments`, 'info');

                let shipmentsWithDest = 0;
                let totalDocsFound = 0;
                shipmentsWithDocuments = [];
                documentsToTransfer = [];

                // Analyze each shipment
                for (const shipment of shipments) {
                    if (shipment.destination) {
                        shipmentsWithDest++;

                        // Check if destination contains document data
                        let destData = shipment.destination;

                        // Handle if it's a string that needs parsing
                        if (typeof destData === 'string') {
                            try {
                                destData = JSON.parse(destData);
                            } catch (e) {
                                // Not JSON, skip
                                continue;
                            }
                        }

                        // Check if it's an array of documents
                        if (Array.isArray(destData)) {
                            const docs = destData.filter(item => isDocumentData(item));
                            if (docs.length > 0) {
                                shipmentsWithDocuments.push({
                                    id: shipment.id,
                                    documents: docs,
                                    existingDocs: shipment.documents || []
                                });
                                documentsToTransfer.push(...docs);
                                totalDocsFound += docs.length;
                                addLog(`Found ${docs.length} documents in shipment ${shipment.id}`, 'success');
                            }
                        }
                        // Check if destination itself is a single document object
                        else if (isDocumentData(destData)) {
                            shipmentsWithDocuments.push({
                                id: shipment.id,
                                documents: [destData],
                                existingDocs: shipment.documents || []
                            });
                            documentsToTransfer.push(destData);
                            totalDocsFound++;
                            addLog(`Found 1 document in shipment ${shipment.id}`, 'success');
                        }
                    }
                }

                // Show statistics
                showStats({
                    totalShipments: shipments.length,
                    shipmentsWithDestination: shipmentsWithDest,
                    documentsFound: totalDocsFound,
                    shipmentsToUpdate: shipmentsWithDocuments.length
                });

                if (shipmentsWithDocuments.length > 0) {
                    showStatus(`Analysis complete! Found ${totalDocsFound} documents in ${shipmentsWithDocuments.length} shipments.`, 'success');
                    document.getElementById('previewBtn').disabled = false;
                } else {
                    showStatus('No documents found in destination column. Nothing to transfer.', 'info');
                }

            } catch (error) {
                console.error('Error:', error);
                addLog(`Error: ${error.message}`, 'error');
                showStatus(`Analysis failed: ${error.message}`, 'error');
            }
        }

        function previewTransfer() {
            try {
                addLog('Generating preview...', 'info');

                const previewDiv = document.getElementById('preview');
                previewDiv.style.display = 'block';

                // Show first 3 documents as preview
                const preview = documentsToTransfer.slice(0, 3);
                previewDiv.innerHTML = `<strong>Sample documents to transfer:</strong>\n\n` +
                    preview.map(doc => JSON.stringify(doc, null, 2)).join('\n\n') +
                    (documentsToTransfer.length > 3 ? `\n\n... and ${documentsToTransfer.length - 3} more documents` : '');

                addLog('Preview generated. Review the documents above.', 'info');
                addLog('These documents will be moved from destination to documents column.', 'warning');

                document.getElementById('transferBtn').disabled = false;
                showStatus('Preview ready. Click "Execute Transfer" to proceed.', 'info');

            } catch (error) {
                console.error('Error:', error);
                addLog(`Error: ${error.message}`, 'error');
                showStatus(`Preview failed: ${error.message}`, 'error');
            }
        }

        async function executeTransfer() {
            try {
                if (!confirm(`Are you sure you want to transfer ${documentsToTransfer.length} documents from ${shipmentsWithDocuments.length} shipments?`)) {
                    return;
                }

                addLog('Starting transfer...', 'info');
                let successCount = 0;
                let errorCount = 0;

                for (const shipmentData of shipmentsWithDocuments) {
                    try {
                        // Combine existing documents with new ones
                        const allDocuments = [
                            ...(shipmentData.existingDocs || []),
                            ...shipmentData.documents
                        ];

                        // Update the shipment
                        const { error } = await supabase
                            .from('shipments')
                            .update({
                                documents: allDocuments,
                                destination: null, // Clear destination since we moved the documents
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', shipmentData.id);

                        if (error) {
                            addLog(`‚ùå Failed to update shipment ${shipmentData.id}: ${error.message}`, 'error');
                            errorCount++;
                        } else {
                            addLog(`‚úÖ Updated shipment ${shipmentData.id} with ${shipmentData.documents.length} documents`, 'success');
                            successCount++;
                        }

                    } catch (err) {
                        addLog(`‚ùå Error processing shipment ${shipmentData.id}: ${err.message}`, 'error');
                        errorCount++;
                    }
                }

                if (successCount > 0) {
                    showStatus(`Transfer complete! Successfully updated ${successCount} shipments. ${errorCount} errors.`, 'success');
                    document.getElementById('verifyBtn').disabled = false;
                } else {
                    showStatus(`Transfer failed. ${errorCount} errors occurred.`, 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                addLog(`Error: ${error.message}`, 'error');
                showStatus(`Transfer failed: ${error.message}`, 'error');
            }
        }

        async function verifyTransfer() {
            try {
                addLog('Verifying transfer...', 'info');

                // Check updated shipments
                const shipmentIds = shipmentsWithDocuments.map(s => s.id);
                const { data: updated, error } = await supabase
                    .from('shipments')
                    .select('id, documents, destination')
                    .in('id', shipmentIds);

                if (error) throw error;

                let verifiedCount = 0;
                let issueCount = 0;

                for (const shipment of updated) {
                    if (shipment.documents && Array.isArray(shipment.documents) && shipment.documents.length > 0) {
                        verifiedCount++;
                        addLog(`‚úÖ Shipment ${shipment.id}: ${shipment.documents.length} documents`, 'success');
                    } else {
                        issueCount++;
                        addLog(`‚ö†Ô∏è Shipment ${shipment.id}: No documents found`, 'warning');
                    }

                    // Check if destination was cleared
                    if (shipment.destination) {
                        addLog(`‚ÑπÔ∏è Shipment ${shipment.id} still has destination data`, 'info');
                    }
                }

                showStatus(`Verification complete! ${verifiedCount} shipments have documents. ${issueCount} issues found.`,
                    issueCount > 0 ? 'warning' : 'success');

                // Show final statistics
                const { data: allShipments, error: statsError } = await supabase
                    .from('shipments')
                    .select('id, documents');

                if (!statsError) {
                    const withDocs = allShipments.filter(s => s.documents && Array.isArray(s.documents) && s.documents.length > 0);
                    addLog(`üìä Final stats: ${withDocs.length} total shipments have documents`, 'info');
                }

            } catch (error) {
                console.error('Error:', error);
                addLog(`Error: ${error.message}`, 'error');
                showStatus(`Verification failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>