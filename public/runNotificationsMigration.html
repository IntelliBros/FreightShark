<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run Notifications Migration</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
    <div class="max-w-2xl w-full bg-white rounded-lg shadow-xl p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Notifications Table Migration</h1>

        <div class="space-y-4 mb-8">
            <p class="text-gray-600">
                This migration will create the notifications table for storing in-app notifications in the database.
            </p>

            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-semibold text-blue-800 mb-2">What this migration does:</h3>
                <ul class="list-disc list-inside text-sm text-blue-700 space-y-1">
                    <li>Creates the notifications table</li>
                    <li>Sets up indexes for performance</li>
                    <li>Adds auto-update timestamp trigger</li>
                    <li>Configures Row Level Security (RLS) policies</li>
                </ul>
            </div>
        </div>

        <form id="migrationForm" class="space-y-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Supabase URL</label>
                <input id="supabaseUrl" type="text" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Service Role Key (Admin)</label>
                <input id="supabaseKey" type="password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                Run Migration
            </button>
        </form>

        <div id="migrationResult" class="hidden">
            <div class="bg-gray-100 p-4 rounded-lg">
                <h3 class="font-semibold mb-2">Migration Output:</h3>
                <pre id="resultContent" class="text-sm overflow-x-auto whitespace-pre-wrap"></pre>
            </div>
        </div>
    </div>

    <script type="module">
        const form = document.getElementById('migrationForm');
        const resultDiv = document.getElementById('migrationResult');
        const resultContent = document.getElementById('resultContent');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const supabaseKey = document.getElementById('supabaseKey').value;

            resultDiv.classList.remove('hidden');
            resultContent.textContent = 'Running migration...';

            try {
                // The complete migration SQL
                const migrationSQL = `
-- Create notifications table for in-app notifications
CREATE TABLE IF NOT EXISTS notifications (
    id VARCHAR(100) PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL, -- 'quote', 'shipment', 'invoice', 'sample', 'message'
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    icon VARCHAR(50),
    link VARCHAR(255),
    read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_notifications_user_id ON notifications(user_id);
CREATE INDEX IF NOT EXISTS idx_notifications_created_at ON notifications(created_at);
CREATE INDEX IF NOT EXISTS idx_notifications_read ON notifications(read);
CREATE INDEX IF NOT EXISTS idx_notifications_user_read ON notifications(user_id, read);

-- Create function to auto-update updated_at timestamp
CREATE OR REPLACE FUNCTION update_notifications_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger to auto-update timestamp
DROP TRIGGER IF EXISTS trigger_notifications_updated_at ON notifications;
CREATE TRIGGER trigger_notifications_updated_at
BEFORE UPDATE ON notifications
FOR EACH ROW
EXECUTE FUNCTION update_notifications_updated_at();

-- Enable Row Level Security
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if they exist
DROP POLICY IF EXISTS notifications_select_policy ON notifications;
DROP POLICY IF EXISTS notifications_insert_policy ON notifications;
DROP POLICY IF EXISTS notifications_update_policy ON notifications;
DROP POLICY IF EXISTS notifications_delete_policy ON notifications;

-- Create RLS policies
-- Users can only see their own notifications
CREATE POLICY notifications_select_policy ON notifications
FOR SELECT USING (
    auth.uid()::text = user_id OR
    auth.uid()::text IN (SELECT id FROM users WHERE role IN ('admin', 'staff'))
);

-- Only staff and admin can insert notifications
CREATE POLICY notifications_insert_policy ON notifications
FOR INSERT WITH CHECK (
    auth.uid()::text IN (SELECT id FROM users WHERE role IN ('admin', 'staff'))
);

-- Users can update their own notifications (mark as read), staff/admin can update any
CREATE POLICY notifications_update_policy ON notifications
FOR UPDATE USING (
    auth.uid()::text = user_id OR
    auth.uid()::text IN (SELECT id FROM users WHERE role IN ('admin', 'staff'))
);

-- Only admin can delete notifications
CREATE POLICY notifications_delete_policy ON notifications
FOR DELETE USING (
    auth.uid()::text IN (SELECT id FROM users WHERE role = 'admin')
);`;

                const response = await fetch(`${supabaseUrl}/rest/v1/rpc/exec_sql`, {
                    method: 'POST',
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: migrationSQL })
                });

                if (response.ok) {
                    resultContent.textContent = 'Migration completed successfully!\n\nNotifications table created with:\n- Indexes for performance\n- Auto-update timestamp trigger\n- RLS policies configured';
                    resultContent.classList.add('text-green-600');
                } else {
                    // Try direct SQL execution
                    const sqlStatements = migrationSQL.split(';').filter(s => s.trim());
                    let errors = [];
                    let successes = 0;

                    for (const statement of sqlStatements) {
                        if (!statement.trim()) continue;

                        try {
                            const res = await fetch(`${supabaseUrl}/rest/v1/rpc/exec_sql`, {
                                method: 'POST',
                                headers: {
                                    'apikey': supabaseKey,
                                    'Authorization': `Bearer ${supabaseKey}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ query: statement + ';' })
                            });

                            if (res.ok) {
                                successes++;
                            } else {
                                const error = await res.text();
                                errors.push(`Statement failed: ${error}`);
                            }
                        } catch (err) {
                            errors.push(`Error: ${err.message}`);
                        }
                    }

                    if (errors.length === 0) {
                        resultContent.textContent = `Migration completed successfully!\n\n${successes} statements executed.`;
                        resultContent.classList.add('text-green-600');
                    } else {
                        resultContent.textContent = `Migration partially completed.\n\n${successes} statements succeeded.\n\nErrors:\n${errors.join('\n')}`;
                        resultContent.classList.add('text-yellow-600');
                    }
                }
            } catch (error) {
                resultContent.textContent = `Error: ${error.message}`;
                resultContent.classList.add('text-red-600');
            }
        });

        // Auto-fill if we have saved values
        const savedUrl = localStorage.getItem('supabase_url');
        const savedKey = localStorage.getItem('supabase_service_key');
        if (savedUrl) document.getElementById('supabaseUrl').value = savedUrl;
        if (savedKey) document.getElementById('supabaseKey').value = savedKey;

        // Save values on submit
        form.addEventListener('submit', () => {
            localStorage.setItem('supabase_url', document.getElementById('supabaseUrl').value);
            localStorage.setItem('supabase_service_key', document.getElementById('supabaseKey').value);
        });
    </script>
</body>
</html>