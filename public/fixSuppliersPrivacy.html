<!DOCTYPE html>
<html>
<head>
    <title>Fix Suppliers Privacy - URGENT SECURITY FIX</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .urgent {
            background-color: #fee;
            border: 2px solid #f00;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .sql-box {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background-color: #0056b3;
        }
        #status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>üîí Fix Suppliers Privacy - URGENT SECURITY FIX</h1>

    <div class="urgent">
        <h2>‚ö†Ô∏è IMPORTANT: Suppliers are currently visible to ALL users!</h2>
        <p>This is a critical privacy issue. Suppliers should only be visible to the user who created them.</p>
        <p><strong>Run the SQL below in your Supabase SQL Editor immediately to fix this issue.</strong></p>
    </div>

    <h2>Step 1: Copy this SQL</h2>
    <div class="sql-box">-- URGENT: Fix suppliers privacy - make them user-specific
-- Add user_id column if it doesn't exist
ALTER TABLE suppliers
ADD COLUMN IF NOT EXISTS user_id VARCHAR(50) REFERENCES users(id) ON DELETE CASCADE;

-- Create index for faster user-specific queries
CREATE INDEX IF NOT EXISTS idx_suppliers_user ON suppliers(user_id);

-- Enable Row Level Security
ALTER TABLE suppliers ENABLE ROW LEVEL SECURITY;

-- Drop any existing loose policies
DROP POLICY IF EXISTS "Anyone can view suppliers" ON suppliers;
DROP POLICY IF EXISTS "Authenticated users can create suppliers" ON suppliers;
DROP POLICY IF EXISTS "Authenticated users can update suppliers" ON suppliers;
DROP POLICY IF EXISTS "Users can view own suppliers" ON suppliers;
DROP POLICY IF EXISTS "Users can create own suppliers" ON suppliers;
DROP POLICY IF EXISTS "Users can update own suppliers" ON suppliers;
DROP POLICY IF EXISTS "Users can delete own suppliers" ON suppliers;

-- Create STRICT RLS policies - SUPPLIERS ARE NOW USER-SPECIFIC
-- Users can only see their own suppliers
CREATE POLICY "Users can view own suppliers" ON suppliers
    FOR SELECT USING (user_id = auth.uid()::text);

-- Users can only create suppliers for themselves
CREATE POLICY "Users can create own suppliers" ON suppliers
    FOR INSERT WITH CHECK (user_id = auth.uid()::text);

-- Users can only update their own suppliers
CREATE POLICY "Users can update own suppliers" ON suppliers
    FOR UPDATE USING (user_id = auth.uid()::text);

-- Users can only delete their own suppliers
CREATE POLICY "Users can delete own suppliers" ON suppliers
    FOR DELETE USING (user_id = auth.uid()::text);

-- Grant permissions
GRANT ALL ON suppliers TO authenticated;

-- Check if any suppliers exist without user_id (orphaned suppliers)
SELECT COUNT(*) as orphaned_count FROM suppliers WHERE user_id IS NULL;</div>

    <h2>Step 2: Go to Supabase SQL Editor</h2>
    <p>1. Log into your <a href="https://app.supabase.com" target="_blank">Supabase Dashboard</a></p>
    <p>2. Select your project (isvuolzqqjutrfytebtl)</p>
    <p>3. Go to SQL Editor from the left sidebar</p>
    <p>4. Paste the SQL above and click "Run"</p>

    <h2>Step 3: Handle Existing Suppliers (if any)</h2>
    <p>If you have existing suppliers without a user_id, you need to either:</p>
    <ul>
        <li>Delete them: <code>DELETE FROM suppliers WHERE user_id IS NULL;</code></li>
        <li>Assign them to a specific user: <code>UPDATE suppliers SET user_id = 'user-id-here' WHERE user_id IS NULL;</code></li>
    </ul>

    <button onclick="checkStatus()">Check Current Status</button>
    <div id="status"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const { createClient } = supabase;
        const supabaseUrl = 'https://isvuolzqqjutrfytebtl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzdnVvbHpxcWp1dHJmeXRlYnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNzMzMDksImV4cCI6MjA3Mjk0OTMwOX0.-TXgy5LNMMpjSSTq78P4QvQAO1QXJia07cdVBHchHRU';
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        async function checkStatus() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = 'Checking...';

            try {
                // Try to query suppliers (this will fail if RLS is properly set up and user not logged in)
                const { data, error, count } = await supabaseClient
                    .from('suppliers')
                    .select('*', { count: 'exact', head: true });

                if (error) {
                    if (error.code === 'PGRST301') {
                        statusDiv.className = 'success';
                        statusDiv.innerHTML = '‚úÖ Good! RLS is enabled and working. Suppliers are now user-specific.';
                    } else {
                        statusDiv.className = 'error';
                        statusDiv.innerHTML = `Error: ${error.message}`;
                    }
                } else {
                    statusDiv.className = 'error';
                    statusDiv.innerHTML = `‚ö†Ô∏è WARNING: Can access suppliers without authentication! Found ${count || 0} suppliers. Please run the SQL above immediately!`;
                }
            } catch (e) {
                statusDiv.className = 'error';
                statusDiv.innerHTML = `Error checking status: ${e.message}`;
            }
        }

        // Auto-check on load
        window.addEventListener('load', checkStatus);
    </script>
</body>
</html>