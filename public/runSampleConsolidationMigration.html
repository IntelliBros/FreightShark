<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run Sample Consolidation Migration</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow p-6">
            <h1 class="text-2xl font-bold mb-4">Sample Consolidation Database Migration</h1>

            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h2 class="font-semibold text-blue-900 mb-2">This migration will create:</h2>
                <ul class="list-disc list-inside text-blue-800 space-y-1">
                    <li>sample_requests table - Stores consolidation requests</li>
                    <li>received_samples table - Tracks scanned samples</li>
                    <li>Automatic triggers for status updates</li>
                    <li>Row Level Security policies</li>
                    <li>Database indexes for performance</li>
                </ul>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Supabase URL</label>
                    <input type="text" id="supabaseUrl" class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           placeholder="https://your-project.supabase.co">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Supabase Service Key</label>
                    <input type="password" id="supabaseKey" class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           placeholder="Your service role key">
                </div>

                <button onclick="runMigration()"
                        class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
                    Run Migration
                </button>
            </div>

            <div id="result" class="mt-6 hidden">
                <h3 class="font-semibold mb-2">Migration Result:</h3>
                <pre id="resultContent" class="bg-gray-100 p-4 rounded overflow-x-auto text-sm"></pre>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        window.runMigration = async function() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');

            if (!url || !key) {
                alert('Please enter both Supabase URL and Service Key');
                return;
            }

            try {
                const supabase = createClient(url, key);

                const migrationSQL = `
-- Sample Consolidation Tables
-- This migration adds support for sample consolidation feature

-- Create sample_requests table
CREATE TABLE IF NOT EXISTS sample_requests (
    id VARCHAR(100) PRIMARY KEY,
    user_id VARCHAR(50) REFERENCES users(id) ON DELETE CASCADE,
    product_name VARCHAR(255) NOT NULL,
    expected_samples INTEGER NOT NULL,
    received_samples INTEGER DEFAULT 0,
    status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'partially_received', 'completed')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create received_samples table
CREATE TABLE IF NOT EXISTS received_samples (
    id VARCHAR(100) PRIMARY KEY,
    sample_request_id VARCHAR(100) REFERENCES sample_requests(id) ON DELETE CASCADE,
    barcode VARCHAR(255) NOT NULL UNIQUE,
    received_by VARCHAR(50) REFERENCES users(id),
    received_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(50) DEFAULT 'in_warehouse' CHECK (status IN ('in_warehouse', 'consolidated', 'shipped')),
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_sample_requests_user_id ON sample_requests(user_id);
CREATE INDEX IF NOT EXISTS idx_sample_requests_status ON sample_requests(status);
CREATE INDEX IF NOT EXISTS idx_received_samples_request_id ON received_samples(sample_request_id);
CREATE INDEX IF NOT EXISTS idx_received_samples_barcode ON received_samples(barcode);

-- Create trigger to update sample_request status when samples are received
CREATE OR REPLACE FUNCTION update_sample_request_status()
RETURNS TRIGGER AS $$
BEGIN
    -- Update the received_samples count
    UPDATE sample_requests
    SET received_samples = (
        SELECT COUNT(*)
        FROM received_samples
        WHERE sample_request_id = NEW.sample_request_id
    ),
    status = CASE
        WHEN (
            SELECT COUNT(*)
            FROM received_samples
            WHERE sample_request_id = NEW.sample_request_id
        ) >= expected_samples THEN 'completed'
        WHEN (
            SELECT COUNT(*)
            FROM received_samples
            WHERE sample_request_id = NEW.sample_request_id
        ) > 0 THEN 'partially_received'
        ELSE 'pending'
    END,
    updated_at = CURRENT_TIMESTAMP
    WHERE id = NEW.sample_request_id;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Drop trigger if exists and recreate
DROP TRIGGER IF EXISTS trigger_update_sample_status ON received_samples;
CREATE TRIGGER trigger_update_sample_status
AFTER INSERT OR DELETE ON received_samples
FOR EACH ROW
EXECUTE FUNCTION update_sample_request_status();

-- Add RLS (Row Level Security) policies
ALTER TABLE sample_requests ENABLE ROW LEVEL SECURITY;
ALTER TABLE received_samples ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if they exist
DROP POLICY IF EXISTS sample_requests_select_policy ON sample_requests;
DROP POLICY IF EXISTS sample_requests_insert_policy ON sample_requests;
DROP POLICY IF EXISTS sample_requests_update_policy ON sample_requests;
DROP POLICY IF EXISTS received_samples_select_policy ON received_samples;
DROP POLICY IF EXISTS received_samples_insert_policy ON received_samples;
DROP POLICY IF EXISTS received_samples_update_policy ON received_samples;

-- Policy for sample_requests: Users can see their own requests, staff and admin can see all
CREATE POLICY sample_requests_select_policy ON sample_requests
    FOR SELECT
    USING (
        user_id = current_setting('request.jwt.claims')::json->>'sub'
        OR EXISTS (
            SELECT 1 FROM users
            WHERE id = current_setting('request.jwt.claims')::json->>'sub'
            AND role IN ('staff', 'admin')
        )
    );

-- Policy for sample_requests: Users can insert their own requests
CREATE POLICY sample_requests_insert_policy ON sample_requests
    FOR INSERT
    WITH CHECK (user_id = current_setting('request.jwt.claims')::json->>'sub');

-- Policy for sample_requests: Only staff and admin can update
CREATE POLICY sample_requests_update_policy ON sample_requests
    FOR UPDATE
    USING (
        EXISTS (
            SELECT 1 FROM users
            WHERE id = current_setting('request.jwt.claims')::json->>'sub'
            AND role IN ('staff', 'admin')
        )
    );

-- Policy for received_samples: Users can see samples for their requests, staff and admin can see all
CREATE POLICY received_samples_select_policy ON received_samples
    FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM sample_requests
            WHERE id = received_samples.sample_request_id
            AND user_id = current_setting('request.jwt.claims')::json->>'sub'
        )
        OR EXISTS (
            SELECT 1 FROM users
            WHERE id = current_setting('request.jwt.claims')::json->>'sub'
            AND role IN ('staff', 'admin')
        )
    );

-- Policy for received_samples: Only staff and admin can insert
CREATE POLICY received_samples_insert_policy ON received_samples
    FOR INSERT
    WITH CHECK (
        EXISTS (
            SELECT 1 FROM users
            WHERE id = current_setting('request.jwt.claims')::json->>'sub'
            AND role IN ('staff', 'admin')
        )
    );

-- Policy for received_samples: Only staff and admin can update
CREATE POLICY received_samples_update_policy ON received_samples
    FOR UPDATE
    USING (
        EXISTS (
            SELECT 1 FROM users
            WHERE id = current_setting('request.jwt.claims')::json->>'sub'
            AND role IN ('staff', 'admin')
        )
    );
                `;

                // Execute the migration
                const { data, error } = await supabase.rpc('exec_sql', {
                    sql: migrationSQL
                }).single();

                if (error) {
                    // If RPC doesn't exist, try direct query (for testing)
                    const response = await fetch(`${url}/rest/v1/rpc/exec_sql`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': key,
                            'Authorization': `Bearer ${key}`
                        },
                        body: JSON.stringify({ sql: migrationSQL })
                    });

                    if (!response.ok) {
                        throw new Error(`Migration failed: ${response.statusText}`);
                    }
                }

                resultDiv.classList.remove('hidden');
                resultContent.textContent = 'Migration completed successfully!\n\nTables created:\n- sample_requests\n- received_samples\n\nTriggers, indexes, and RLS policies have been set up.';
                resultContent.className = 'bg-green-100 p-4 rounded text-green-800 text-sm';
            } catch (error) {
                resultDiv.classList.remove('hidden');
                resultContent.textContent = `Error: ${error.message}\n\nNote: You may need to run this SQL directly in the Supabase SQL Editor if the RPC function is not available.`;
                resultContent.className = 'bg-red-100 p-4 rounded text-red-800 text-sm';
            }
        }
    </script>
</body>
</html>