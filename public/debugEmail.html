<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Email Configuration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .output {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .info {
            color: blue;
        }
        pre {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Email Configuration Debug</h1>

    <div class="container">
        <h2>Current SMTP Configuration</h2>
        <button onclick="checkConfig()">Check Current Config</button>
        <button onclick="setDefaultConfig()" class="secondary">Set Default Config (Gmail)</button>
        <button onclick="clearConfig()" class="danger">Clear Config</button>
        <div id="configOutput" class="output"></div>
    </div>

    <div class="container">
        <h2>Configure SMTP</h2>
        <label>SMTP Host:</label>
        <input type="text" id="smtpHost" placeholder="smtp.gmail.com" value="smtp.gmail.com">

        <label>SMTP Port:</label>
        <input type="number" id="smtpPort" placeholder="587" value="587">

        <label>Secure (TLS/SSL):</label>
        <select id="smtpSecure">
            <option value="false">No (use STARTTLS)</option>
            <option value="true">Yes (SSL)</option>
        </select>

        <label>Username (Email):</label>
        <input type="email" id="smtpUser" placeholder="your-email@gmail.com">

        <label>Password/App Password:</label>
        <input type="password" id="smtpPass" placeholder="App-specific password">

        <label>From Name:</label>
        <input type="text" id="fromName" placeholder="Freight Shark" value="Freight Shark">

        <label>From Email:</label>
        <input type="email" id="fromEmail" placeholder="noreply@freightshark.com">

        <button onclick="saveConfig()">Save Configuration</button>
    </div>

    <div class="container">
        <h2>Test Email Sending</h2>
        <label>Recipient Email:</label>
        <input type="email" id="testEmail" placeholder="test@example.com">

        <label>Template:</label>
        <select id="templateId">
            <option value="sample-received">Sample Received</option>
            <option value="quote-ready">Quote Ready</option>
            <option value="shipment-update">Shipment Update</option>
        </select>

        <button onclick="testEmail()">Send Test Email</button>
        <button onclick="simulateSampleReceived()" class="secondary">Simulate Sample Received</button>

        <div id="emailOutput" class="output"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const output = document.getElementById(elementId);
            const timestamp = new Date().toISOString();
            output.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            console.log(message);
        }

        function checkConfig() {
            const config = localStorage.getItem('freight_shark_smtp_config');
            const output = document.getElementById('configOutput');

            if (config) {
                const parsed = JSON.parse(config);
                // Hide password for security
                const displayConfig = {
                    ...parsed,
                    auth: {
                        ...parsed.auth,
                        pass: '***HIDDEN***'
                    }
                };
                output.innerHTML = `<pre>${JSON.stringify(displayConfig, null, 2)}</pre>`;
                log('configOutput', 'SMTP configuration found', 'success');
            } else {
                output.innerHTML = '<p class="error">No SMTP configuration found in localStorage</p>';
                log('configOutput', 'No SMTP configuration found - emails will be simulated', 'error');
            }
        }

        function setDefaultConfig() {
            const defaultConfig = {
                host: 'smtp.gmail.com',
                port: 587,
                secure: false,
                auth: {
                    user: 'your-email@gmail.com',
                    pass: 'your-app-password'
                },
                from: {
                    name: 'Freight Shark',
                    email: 'noreply@freightshark.com'
                }
            };

            localStorage.setItem('freight_shark_smtp_config', JSON.stringify(defaultConfig));
            log('configOutput', 'Default configuration set (update with your credentials)', 'info');
            checkConfig();
        }

        function clearConfig() {
            localStorage.removeItem('freight_shark_smtp_config');
            log('configOutput', 'SMTP configuration cleared', 'success');
            document.getElementById('configOutput').innerHTML = '';
        }

        function saveConfig() {
            const config = {
                host: document.getElementById('smtpHost').value,
                port: parseInt(document.getElementById('smtpPort').value),
                secure: document.getElementById('smtpSecure').value === 'true',
                auth: {
                    user: document.getElementById('smtpUser').value,
                    pass: document.getElementById('smtpPass').value
                },
                from: {
                    name: document.getElementById('fromName').value,
                    email: document.getElementById('fromEmail').value || document.getElementById('smtpUser').value
                }
            };

            if (!config.host || !config.auth.user || !config.auth.pass) {
                log('configOutput', 'Please fill in all required fields', 'error');
                return;
            }

            localStorage.setItem('freight_shark_smtp_config', JSON.stringify(config));
            log('configOutput', 'Configuration saved successfully', 'success');
            checkConfig();
        }

        async function testEmail() {
            const to = document.getElementById('testEmail').value;
            const templateId = document.getElementById('templateId').value;

            if (!to) {
                log('emailOutput', 'Please enter a recipient email', 'error');
                return;
            }

            const variables = {
                sampleId: 'TEST-001',
                customerName: 'Test Customer',
                productName: 'Test Product',
                consolidationId: 'CONSOL-TEST-001',
                receivedDate: new Date().toLocaleDateString(),
                quoteNumber: 'Q-00001',
                shipmentId: 'FS-00001',
                trackingNumber: '1234567890'
            };

            log('emailOutput', `Sending test email to ${to} with template ${templateId}...`, 'info');

            // Import EmailService
            const module = await import('/src/services/EmailService.ts');
            const emailService = module.emailService;

            const result = await emailService.sendNotification(to, templateId, variables);

            if (result.success) {
                log('emailOutput', `Email sent successfully: ${result.message}`, 'success');
            } else {
                log('emailOutput', `Failed to send email: ${result.message}`, 'error');
            }
        }

        async function simulateSampleReceived() {
            const to = document.getElementById('testEmail').value || 'customer@example.com';

            log('emailOutput', 'Simulating sample received notification...', 'info');

            // Get or create test customer
            const testCustomer = {
                id: 'test-customer-123',
                email: to,
                name: 'Test Customer',
                company: 'Test Company',
                phone: '555-0123',
                role: 'customer'
            };

            // Simulate sample data
            const sample = {
                id: 'SAMPLE-TEST-001',
                product_name: 'Test Product',
                consolidation_id: 'CONSOL-001',
                received_date: new Date().toISOString()
            };

            // Import NotificationService
            const module = await import('/src/services/NotificationService.ts');
            const notificationService = module.notificationService;

            try {
                await notificationService.notifySampleReceived(sample, testCustomer);
                log('emailOutput', 'Sample received notification sent successfully', 'success');

                // Check console for actual email status
                log('emailOutput', 'Check browser console for detailed email status', 'info');
            } catch (error) {
                log('emailOutput', `Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Check config on load
        window.onload = () => {
            checkConfig();
        };
    </script>
</body>
</html>